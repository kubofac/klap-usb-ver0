<!DOCTYPEhtml>
<htmllang="ja">
<head>
<metacharset="UTF-8"/>
<metaname="viewport"content="width=device-width,user-scalable=no">
<title>KLAP_ver3(WebUSB10Hzå¯¾å¿œ-é€Ÿåº¦éä¾å­˜)</title>
<linkrel="manifest"href="/manifest.json">
<style>
html,body{
height:100%;
margin:0;
}
body{
font-family:Arial,sans-serif;
display:flex;
flex-direction:column;
align-items:center;
justify-content:center;
min-height:100vh;
background-color:#000000;
color:#ffffff;
padding:10px;
position:relative;
}
#container{
display:flex;
flex-direction:column;
align-items:center;
background:#1c1c1e;
border-radius:10px;
box-shadow:04px8pxrgba(0,0,0,0.3);
padding:20px;
max-width:100%;
margin:20pxauto;
width:100%;
box-sizing:border-box;
height:100%;
position:relative;
}
#main-content{
display:flex;
width:100%;
gap:20px;
align-items:flex-start;
justify-content:space-between;
flex-grow:1;
margin-bottom:20px;
}
#time-display-column{
display:flex;
flex-direction:column;
align-items:flex-start;
flex-grow:1;
}
#lap-list-column{
display:flex;
flex-direction:column;
width:400px;
flex-shrink:0;
}
#display1{
font-size:90px;
font-weight:bold;
color:#eeeeee;
margin-bottom:5px;
}
#display{
font-size:60px;
font-weight:bold;
color:#cccccc;
margin-bottom:10px;
}
#lap_list{
width:100%;
height:200px;
overflow-y:auto;
border:none;
border-radius:5px;
background-color:#1c1c1e;
padding:10px;
}
#lap_listdiv{
font-size:2.5em;
margin-bottom:5px;
color:#dddddd;
}
#buttons-row{
display:flex;
justify-content:space-around;
width:100%;
gap:15px;
padding-top:10px;
}
.button{
border:1pxsolid#3a3a3c;
background-color:#2c2c2e;
padding:10px15px;
color:#ffffff;
font-size:16px;
font-weight:500;
border-radius:5px;
cursor:pointer;
transition:background-color0.2sease;
text-align:center;
flex-grow:1;
}
.button:hover{background-color:#4a4a4e;}
#start:active{background-color:#4a804a;}
#reset:active{background-color:#993333;}
#lap:active{background-color:#4a4a4e;}
.no-setting{background-color:#ff4d4d;}
.no-setting:hover{background-color:#ff6666;}
.no-setting:active{background-color:#e64444;}
.no-gps{background-color:#ff4d4d;}
.no-gps:hover{background-color:#ff6666;}
.no-gps:active{background-color:#e64444;}
.active-blue{background-color:#007aff;}
.active-blue:hover{background-color:#3399ff;}
.active-blue:active{background-color:#0066cc;}
#debug-overlay{
position:absolute;
top:0;
left:0;
background-color:transparent;
color:#ffffff;
padding:10px;
border-radius:5px;
z-index:1000;
font-size:14px;
line-height:1.5;
width:100%;
box-sizing:border-box;
pointer-events:none;
opacity:0.9;
text-align:left;
}
.status-text{
margin:0;
}
#debug-overlay#debugInfo{
margin-top:5px;
line-height:1.2;
}
/*NMEAãƒ­ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ«*/
#nmeaLog{
/*NMEAãƒ­ã‚°è¡¨ç¤ºã‚’éè¡¨ç¤º*/
display:none;
height:30px;
overflow:hidden;
border:1pxsolid#ccc;
padding:5px;
font-size:10px;
background-color:#000;
white-space:pre;
pointer-events:all;
line-height:1;
}
@media(max-width:480px){
#main-content{
flex-direction:column;
align-items:center;
gap:20px;
}
#time-display-column,#lap-list-column{
width:100%;
align-items:center;
}
#buttons-row{
flex-direction:row;
flex-wrap:wrap;
justify-content:center;
width:100%;
align-items:center;
}
.button{
width:auto;
flex-grow:1;
padding:10px8px;
font-size:14px;
}
#display1{font-size:40px;}
#display{font-size:25px;}
#lap_listdiv{
font-size:1.6em;
}
#debug-overlay{
width:auto;
}
#nmeaLog{
font-size:8px;
}
}
</style>
</head>
<body>
<divid="container">
<divid="debug-overlay">
<pid="status-display"class="status-text">GPSè¨­å®š:æœªå–å¾—</p>
<divid="debugInfo"class="status-text"></div>
<divid="nmea-raw-container"style="display:none;">
<pclass="status-text">NMEARawData(Latest):</p>
<preid="nmeaLog">NoNMEAdatayet...</pre>
</div>
</div>
<divid="main-content">
<divid="time-display-column">
<divid='display1'>00:00.000</div>
<divid='display'>00:00:00.000</div>
</div>
<divid="lap-list-column">
<divid='lap_list'></div>
</div>
</div>
<divid="buttons-row">
<buttonid="start"class="button">start</button>
<buttonid="lap"class="button">lap</button>
<buttonid="reset"class="button">reset</button>
<buttonid="gpsButton"class="buttonno-gps">GPS</button>
<buttonid="getSettingsBtn"class="buttonno-setting">GET</button>
</div>
</div>
<script>
'usestrict';
//---ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°---
constSW_STATE={STOP:0,RUN:1,PAUSE:2};
letswState=SW_STATE.STOP;
letstartTime=0;
letlapRecords=[];
letlapCount=0;
letcountUpTimerId=null;
letlapTimerId=null;
letlapStartTime=0;
letisGpsRunning=false;
letlastPosition=null;
letpreviousSideOfLine=null;
letlastLapTime=0;
letgpsThresholdValue=20;
letlapCoolDown=15000;
letisSettingsLoaded=false;
letlapFixedDisplayTimeoutId=null;
constelem={
display:null,
display1:null,
lap_list:null,
statusDisplay:null,
debugInfo:null,
startButton:null,
resetButton:null,
lapButton:null,
gpsButton:null,
getSettingsBtn:null,
nmeaLog:null,
nmeaRawContainer:null
};
//GPSãƒ©ãƒƒãƒ—è¨ˆæ¸¬ç”¨å¤‰æ•°-localStorageã‹ã‚‰èª­ã¿è¾¼ã‚€
letLAP_LINE_P1={lat:0,lon:0};
letLAP_LINE_P2={lat:0,lon:0};
//---WebUSBé–¢é€£ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°---
letdevice=null;
letkeepReading=true;
letnmeaBuffer='';
constNMEA_VENDOR_ID=0x1546;
constNMEA_PRODUCT_ID=0x01A8;
constIN_ENDPOINT=2;
constINTERFACE_NUMBER=1;
//---æ›´æ–°ãƒ¬ãƒ¼ãƒˆ/ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºç”¨å¤‰æ•°---
letlastUpdateTime=0;
letupdateCounter=0;
letdisplayRateTimer=null;
letcurrentUpdateRate=0;
letcurrentLat=0.0;
letcurrentLon=0.0;
//ğŸ’¡RMCãƒ‡ãƒãƒƒã‚°ç”¨å¤‰æ•°
letlatestRmcStatus='N/A';
letlatestRmcRawLatLon='N/A';
letrmcUpdateCounter=0;
letcurrentRmcUpdateRate=0;
//ğŸ’¡GGAãƒ‡ãƒãƒƒã‚°ç”¨å¤‰æ•°
letggaUpdateCounter=0;
letcurrentGgaUpdateRate=0;
letlatestGgaStatus='N/A';//FixQuality
letlatestGgaRawLatLon='N/A';
letlatestGgaFixQuality=0;//<---ADDED:FixQualityã®æ•°å€¤(0:NoFix,1:GPSFix,...)
//------------------------------------
//ğŸ’¡è¿½åŠ ã™ã‚‹ãƒ‡ãƒãƒƒã‚°æƒ…å ±ç”¨ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
letlatestDistance=0.0;
letlatestTimeSinceLap=0;
letlatestIsCrossing=false;
//---ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒé–¢é€£ã®é–¢æ•°---
consttotalTimePrint=(time)=>{
leth=Math.floor(time/3600000);
letm=Math.floor((time%3600000)/60000);
lets=Math.floor((time%60000)/1000);
letms=Math.floor(time%1000);
h=('0'+h).slice(-2);
m=('0'+m).slice(-2);
s=('0'+s).slice(-2);
ms=('00'+ms).slice(-3);
if(elem.display)elem.display.textContent=`${h}:${m}:${s}.${ms}`;
};
constlapTimeToString=(time)=>{
letm=Math.floor(time/60000);
lets=Math.floor(time%60000/1000);
letms=Math.floor(time%1000);
m=('0'+m).slice(-2);
s=('0'+s).slice(-2);
ms=('00'+ms).slice(-3);
return`${m}:${s}.${ms}`;
};
constcountUp=()=>{
countUpTimerId=requestAnimationFrame(()=>{
constnow=Date.now();
constelapsedTime=now-startTime;
totalTimePrint(elapsedTime);
countUp();
});
};
conststartRealtimeLap=()=>{
if(swState===SW_STATE.RUN){
lapTimerId=requestAnimationFrame(()=>{
constnow=Date.now();
constlapElapsedTime=now-lapStartTime;
constlapDisplay=lapTimeToString(lapElapsedTime);
if(elem.display1)elem.display1.textContent=lapDisplay;
startRealtimeLap();
});
}
};
constlapTimePrint=(time)=>{
constlapDuration=lapTimeToString(time);
constlapDiv=document.createElement('div');
lapDiv.textContent=`[${lapCount}]${lapDuration}`;
lapDiv.style.fontSize='2.5em';
if(elem.lap_list){
elem.lap_list.insertBefore(lapDiv,elem.lap_list.firstChild);
}
lapRecords.push({count:lapCount,time:lapDuration});
};
constupdateButtonDisplay=()=>{
if(elem.lapButton){
elem.lapButton.style.display=(swState===SW_STATE.RUN)?'inline-block':'none';
}
if(elem.resetButton){
elem.resetButton.style.display=(swState===SW_STATE.STOP||swState===SW_STATE.PAUSE)?'inline-block':'none';
}
if(elem.startButton){
elem.startButton.textContent=(swState===SW_STATE.RUN)?'stop':'start';
}
};
constclickStartSW=()=>{
if(!isSettingsLoaded&&swState===SW_STATE.STOP){
if(elem.debugInfo){
elem.debugInfo.innerHTML=`GPSè¨­å®šãŒæœªå–å¾—ã§ã™ã€‚æ‰‹å‹•ã§ã®è¨ˆæ¸¬ã‚’é–‹å§‹ã—ã¾ã™ã€‚<br>${elem.debugInfo.innerHTML}`;
}
}
if(swState===SW_STATE.STOP){
swState=SW_STATE.RUN;
startTime=Date.now();
lapStartTime=Date.now();
lapCount=0;
elem.lap_list.innerHTML='';
countUp();
startRealtimeLap();
}elseif(swState===SW_STATE.RUN){
swState=SW_STATE.PAUSE;
cancelAnimationFrame(countUpTimerId);
cancelAnimationFrame(lapTimerId);
if(lapFixedDisplayTimeoutId){
clearTimeout(lapFixedDisplayTimeoutId);
}
}elseif(swState===SW_STATE.PAUSE){
swState=SW_STATE.RUN;
constnow=Date.now();
constpausedTime=now-lapStartTime;
startTime+=pausedTime;
lapStartTime=now;
countUp();
startRealtimeLap();
}
updateButtonDisplay();
};
constclickLapSW=()=>{
if(swState===SW_STATE.RUN){
lapCount++;
constnow=Date.now();
constlapDuration=now-lapStartTime;
lapTimePrint(lapDuration);
lapStartTime=now;
cancelAnimationFrame(lapTimerId);
startRealtimeLap();
}
};
constclickResetSW=()=>{
swState=SW_STATE.STOP;
startTime=0;
lapRecords=[];
lapCount=0;
cancelAnimationFrame(countUpTimerId);
cancelAnimationFrame(lapTimerId);
if(lapFixedDisplayTimeoutId){
clearTimeout(lapFixedDisplayTimeoutId);
}
totalTimePrint(0);
if(elem.lap_list)elem.lap_list.innerHTML='';
if(elem.display1)elem.display1.textContent='00:00.000';
updateButtonDisplay();
stopGps();
};
constclickGpsButton=()=>{
if(!isGpsRunning){
startGps();
}else{
stopGps();
}
};
constgetSettings=()=>{
constp1Lat=localStorage.getItem('startLineP1Lat');
constp1Lon=localStorage.getItem('startLineP1Lon');
constp2Lat=localStorage.getItem('startLineP2Lat');
constp2Lon=localStorage.getItem('startLineP2Lon');
constthreshold=localStorage.getItem('gpsThreshold');
constcoolDown=localStorage.getItem('lapCoolDownTime');
if(p1Lat&&p1Lon&&p2Lat&&p2Lon){
LAP_LINE_P1={lat:parseFloat(p1Lat),lon:parseFloat(p1Lon)};
LAP_LINE_P2={lat:parseFloat(p2Lat),lon:parseFloat(p2Lon)};
gpsThresholdValue=threshold?parseFloat(threshold):20;
lapCoolDown=coolDown?parseFloat(coolDown):15000;
if(elem.statusDisplay)elem.statusDisplay.textContent=`GPSè¨­å®š:OK(é–¾å€¤:${gpsThresholdValue}m/C/D:${lapCoolDown/1000}ç§’)`;
if(elem.debugInfo)elem.debugInfo.innerHTML="GPSè¨­å®šãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸã€‚";
isSettingsLoaded=true;
elem.getSettingsBtn.classList.remove('no-setting');
elem.getSettingsBtn.classList.add('active-blue');
}else{
if(elem.statusDisplay)elem.statusDisplay.textContent='GPSè¨­å®š:æœªè¨­å®šï¼ˆè¨­å®šãƒ„ãƒ¼ãƒ«ã§ä¿å­˜ã—ã¦ãã ã•ã„ï¼‰';
if(elem.debugInfo)elem.debugInfo.innerHTML="localStorageã«GPSè¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚";
isSettingsLoaded=false;
elem.getSettingsBtn.classList.remove('active-blue');
elem.getSettingsBtn.classList.add('no-setting');
}
};
//----------------------------------------------------------------------
//WebUSB/NMEA/æ›´æ–°ãƒ¬ãƒ¼ãƒˆé–¢é€£ã®é–¢æ•°
//----------------------------------------------------------------------
//NMEAã®DMMãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆåº¦åˆ†.åˆ†ï¼‰ã‚’10é€²æ•°ã«å¤‰æ›ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
functiondmsToDecimal(dmm,direction){
if(!dmm)returnNaN;
constdotIndex=dmm.indexOf('.');
if(dotIndex!==-1){
//NMEADMMå½¢å¼ã§ã¯ã€ã€Œåˆ†ã€ã¯å¸¸ã«å°æ•°ç‚¹å‰ã®2æ¡ã¨å›ºå®š
constminuteStartIndex=dotIndex-2;
if(minuteStartIndex>0){
constdegrees=parseInt(dmm.substring(0,minuteStartIndex));
constminutes=parseFloat(dmm.substring(minuteStartIndex));
if(isNaN(degrees)||isNaN(minutes))returnNaN;
letdecimal=degrees+(minutes/60);
if(direction==='S'||direction==='W'){
decimal=-decimal;
}
returndecimal;
}else{
//åº¦æ•°ãŒå­˜åœ¨ã—ãªã„ãªã©ã®ç•°å¸¸ãƒ‡ãƒ¼ã‚¿
returnNaN;
}
}else{
//å°æ•°ç‚¹ãŒãªã„å ´åˆï¼ˆå¤ã„ãƒ‡ãƒ¼ã‚¿å½¢å¼ã¾ãŸã¯è§£æå¤±æ•—ãƒ‡ãƒ¼ã‚¿ï¼‰ã®å¯¾å¿œ
constnum=parseFloat(dmm);
if(isNaN(num))returnNaN;
if(dmm.length>=4){
constminuteRaw=dmm.slice(-2);
constdegreeRaw=dmm.slice(0,-2);
constdegrees=parseInt(degreeRaw);
constminutes=parseInt(minuteRaw);
letdecimal=degrees+(minutes/60);
if(direction==='S'||direction==='W'){
decimal=-decimal;
}
returndecimal;
}else{
returnNaN;
}
}
}
//NMEAãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è§£æã—ã€ä½ç½®æƒ…å ±ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™(GGAã‚’ä½ç½®ã®ä¸»è»¸ã€RMCã‚’é€Ÿåº¦ã®ä¸»è»¸ã¨ã™ã‚‹)
functionparseNmeaLine(line){
constparts=line.split(',');
//----------------------------------------------------
//1.GNGGAãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‡¦ç†(ä½ç½®æƒ…å ±ã®ä¾›çµ¦æº)
//----------------------------------------------------
if(parts[0].toUpperCase().endsWith('GGA')&&parts.length>=7){
ggaUpdateCounter++;
constfixQuality=parseInt(parts[6]);
latestGgaFixQuality=fixQuality;//FixQualityã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
latestGgaStatus=fixQuality>0?`FIX(${fixQuality})`:'NOFIX';
//GGAãŒæœ‰åŠ¹ãªFixã‚’æŒã¤å ´åˆã€ãã®åº§æ¨™ã§ä½ç½®æƒ…å ±ã‚’æ›´æ–°ã—ã€ãƒ©ãƒƒãƒ—è¨ˆæ¸¬ãƒ­ã‚¸ãƒƒã‚¯ã«æ¸¡ã™
if(fixQuality>0){
constlat=dmsToDecimal(parts[2],parts[3]);
constlon=dmsToDecimal(parts[4],parts[5]);
if(!isNaN(lat)&&!isNaN(lon)){
//ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºç”¨ã®DECåº§æ¨™ã¨RAWDMMã‚’æ›´æ–°
currentLat=lat;
currentLon=lon;
constrawLat=parts.length>2?`${parts[2]}${parts[3]}`:'N/A';
constrawLon=parts.length>4?`${parts[4]}${parts[5]}`:'N/A';
latestGgaRawLatLon=`${rawLat}/${rawLon}`;
realTimeUpdateDebugInfo();//GGAã§åº§æ¨™ãŒæ›´æ–°ã•ã‚ŒãŸã‚‰è¡¨ç¤ºã‚‚æ›´æ–°
updateCounter++;//ç·ãƒ¬ãƒ¼ãƒˆã¯GGAã§ã‚«ã‚¦ãƒ³ãƒˆ
//é€Ÿåº¦ã¯ç›´è¿‘ã®RMCã‹ã‚‰å–å¾—ã™ã‚‹ãŸã‚ã€lastPositionã®é€Ÿåº¦ã‚’ä½¿ã†
//lastPosition.speedã«é€Ÿåº¦ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’å‰æã¨ã™ã‚‹
constcurrentSpeed=(lastPosition&&lastPosition.speed!==null)?lastPosition.speed:0;
return{
coords:{
latitude:lat,
longitude:lon,
speed:currentSpeed,//RMCã‹ã‚‰å–å¾—ã—ãŸæœ€æ–°ã®é€Ÿåº¦
accuracy:1
},
timestamp:Date.now()
};
}
}
returnnull;
}
//----------------------------------------------------
//2.RMCãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‡¦ç†(é€Ÿåº¦æƒ…å ±ã®ä¾›çµ¦æº)
//----------------------------------------------------
elseif(parts[0].toUpperCase().endsWith('RMC')&&parts.length>=8){
rmcUpdateCounter++;
constspeedKnot=parseFloat(parts[7])||0;
constspeedMps=speedKnot*0.514444;
//ãƒ‡ãƒãƒƒã‚°æƒ…å ±æ›´æ–°
latestRmcStatus=parts.length>2?parts[2]:'N/A';
constrawLat=parts.length>3?`${parts[3]}${parts[4]}`:'N/A';
constrawLon=parts.length>5?`${parts[5]}${parts[6]}`:'N/A';
latestRmcRawLatLon=`${rawLat}/${rawLon}`;
//lastPositionã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«é€Ÿåº¦æƒ…å ±ã®ã¿ã‚’ä¿å­˜/æ›´æ–°ã™ã‚‹
if(lastPosition){
lastPosition.speed=speedMps;
}else{
//åˆå›RMCã®å ´åˆã®åˆæœŸåŒ–
lastPosition={
lat:currentLat,//æœ€æ–°ã®GGAåº§æ¨™ï¼ˆã¾ãŸã¯å‰å›å€¤ï¼‰
lon:currentLon,
time:Date.now(),
speed:speedMps
};
}
//RMCã¯ä½ç½®æƒ…å ±ã‚’æä¾›ã—ãªã„ãŸã‚ã€ã“ã“ã§ã¯nullã‚’è¿”ã™
returnnull;
}
returnnull;
}
//NMEAãƒ‡ãƒ¼ã‚¿å‡¦ç†ãƒãƒƒãƒ•ã‚¡ã‚’ç®¡ç†ã—ã€è¡Œã”ã¨ã«ãƒ‘ãƒ¼ã‚µãƒ¼ã«æ¸¡ã™
functionprocessNmeaData(data){
nmeaBuffer+=data;
letnewlineIndex;
while((newlineIndex=nmeaBuffer.indexOf('\n'))!==-1){
constline=nmeaBuffer.substring(0,newlineIndex).trim();
nmeaBuffer=nmeaBuffer.substring(newlineIndex+1);
if(line.startsWith('$')&&line.length>5){
constposition=parseNmeaLine(line);
//------------------------------------------------------------------
//ğŸ’¡å‰Šé™¤ã•ã‚ŒãŸãƒ­ã‚¸ãƒƒã‚¯:
//RMC/GGAãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«é–¢ã™ã‚‹ãƒ‡ãƒãƒƒã‚°æƒ…å ±ï¼ˆåº§æ¨™ã‚„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼‰ã®æ›´æ–°ã¯ã€
//å…¨ã¦parseNmeaLineé–¢æ•°ã«é›†ç´„ã•ã‚Œã¾ã—ãŸã€‚
//------------------------------------------------------------------
if(position&&swState===SW_STATE.RUN){
onWebUsbPositionUpdate(position);
}
}
}
}
//1ç§’ã”ã¨ã«æ›´æ–°ãƒ¬ãƒ¼ãƒˆã‚’è¨ˆç®—ã—ã¦è¡¨ç¤ºã™ã‚‹ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹
functionstartRateMeasurement(){
if(displayRateTimer!==null){
clearInterval(displayRateTimer);
displayRateTimer=null;
}
currentUpdateRate=0;
updateCounter=0;
currentRmcUpdateRate=0;
rmcUpdateCounter=0;
currentGgaUpdateRate=0;
ggaUpdateCounter=0;
displayRateTimer=setInterval(()=>{
currentUpdateRate=updateCounter;
updateCounter=0;
currentRmcUpdateRate=rmcUpdateCounter;
rmcUpdateCounter=0;
currentGgaUpdateRate=ggaUpdateCounter;
ggaUpdateCounter=0;
updateDebugDisplay();
},1000);
}
//æ›´æ–°ãƒ¬ãƒ¼ãƒˆã®è¨ˆæ¸¬ã‚’åœæ­¢
functionstopRateMeasurement(){
if(displayRateTimer!==null){
clearInterval(displayRateTimer);
displayRateTimer=null;
}
currentUpdateRate=0;
currentRmcUpdateRate=0;
currentGgaUpdateRate=0;
}
//ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ›´æ–°ã•ã‚Œã‚‹ãƒ‡ãƒãƒƒã‚°æƒ…å ±(GGARAWDMM,DECè¡¨ç¤º)
functionrealTimeUpdateDebugInfo(){
//ãƒ‡ãƒãƒƒã‚°æƒ…å ±å…¨ä½“ãŒéè¡¨ç¤ºã§ãªã„ã“ã¨ã‚’ç¢ºèª
if(elem.debugInfo&&elem.debugInfo.parentElement.style.display!=='none'){
constggaRawDmmDisplay=document.getElementById('ggaRawDmmDisplay');
if(ggaRawDmmDisplay){
ggaRawDmmDisplay.textContent=`GGARAWDMM:${latestGgaRawLatLon}`;
}

constdecLatLonDisplay=document.getElementById('decLatLonDisplay');
if(decLatLonDisplay){
decLatLonDisplay.textContent=`DEC:${currentLat.toFixed(6)}/${currentLon.toFixed(6)}`;
}
}
}
//ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
functionupdateDebugDisplay(){
if(!elem.debugInfo)return;

// --- ãƒœã‚¿ãƒ³ã®ã‚¯ãƒ©ã‚¹åˆ¶å¾¡ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ  ---
if(elem.gpsButton&&isGpsRunning){ // GPSç›£è¦–ãŒå®Ÿè¡Œä¸­ã®å ´åˆã®ã¿ãƒœã‚¿ãƒ³ã®è‰²ã‚’æ›´æ–°
    consthasFix=latestGgaFixQuality>=1; // Fix QualityãŒ1ä»¥ä¸Šã§æ¸¬ä½æˆåŠŸã¨è¦‹ãªã™

    if(hasFix){
        elem.gpsButton.textContent='GPS(FIX)'; // è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆã‚‚å¤‰æ›´
        elem.gpsButton.classList.remove('no-gps');
        elem.gpsButton.classList.add('active-blue');
    }else{
        elem.gpsButton.textContent='GPS(NOFIX)'; // æ¸¬ä½ã§ãã¦ã„ãªã„å ´åˆ
        elem.gpsButton.classList.remove('active-blue');
        elem.gpsButton.classList.add('no-gps');
    }
}
// ------------------------------------

//ğŸ’¡æ—¢å­˜ã®ãƒ‡ãƒãƒƒã‚°æƒ…å ±
constrateText=`ç·ãƒ¬ãƒ¼ãƒˆ:${currentUpdateRate.toFixed(0)}Hz|RMCãƒ¬ãƒ¼ãƒˆ:${currentRmcUpdateRate.toFixed(0)}Hz|GGAãƒ¬ãƒ¼ãƒˆ:${currentGgaUpdateRate.toFixed(0)}Hz`;
constrmcStatusText=`RMCStatus:${latestRmcStatus}`;
constggaStatusText=`GGAStatus:${latestGgaStatus}`;
constlatLonText=`<spanid="decLatLonDisplay">DEC:${currentLat.toFixed(6)}/${currentLon.toFixed(6)}</span>`;
constrmcRawText=`RMCRAWDMM:${latestRmcRawLatLon}`;
//lastPosition.speedã‚’å‚ç…§ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£
constspeedText=`é€Ÿåº¦:${(lastPosition&&lastPosition.speed!==null)?lastPosition.speed.toFixed(2):'N/A'}m/s`;
constlapCountText=`å‘¨å›æ•°:${lapCount}`;
//ğŸ’¡è¿½åŠ ã™ã‚‹ãƒ‡ãƒãƒƒã‚°æƒ…å ±
constdistanceText=`è·é›¢:${latestDistance.toFixed(2)}m`;
consttimeSinceLapText=`å‰å›ã‹ã‚‰ã®çµŒéæ™‚é–“:${(latestTimeSinceLap/1000).toFixed(2)}ç§’`;
constcrossingText=`ãƒ©ã‚¤ãƒ³é€šé:${latestIsCrossing}`;
elem.debugInfo.innerHTML=`
${rateText}<br>
${rmcStatusText}|${ggaStatusText}<br>
${latLonText}<br>
${rmcRawText}<br>
<spanid="ggaRawDmmDisplay">GGARAWDMM:${latestGgaRawLatLon}</span><br>
${speedText}|${lapCountText}<br>
${distanceText}|${timeSinceLapText}|${crossingText}
`;
conststatusColor=(latestRmcStatus==='A'||latestGgaStatus.startsWith('FIX'))?'lime':'white';
elem.debugInfo.style.color=statusColor;
//ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºã®æ›´æ–°ã¯parseNmeaLineã§å‘¼ã³å‡ºã•ã‚Œã‚‹realTimeUpdateDebugInfo()ã«ä»»ã›ã‚‹
//realTimeUpdateDebugInfo();
}
//WebUSBãƒ‡ãƒ¼ã‚¿èª­ã¿å–ã‚Šãƒ«ãƒ¼ãƒ—
asyncfunctionreadLoop(){
constnmeaLogElement=elem.nmeaLog;
while(device&&keepReading){
try{
constresult=awaitdevice.transferIn(IN_ENDPOINT,512);
if(result.status==='ok'&&result.data){
constdecoder=newTextDecoder('iso-8859-1');
constnmeaData=decoder.decode(result.data);

//updateCounter++;//parseNmeaLineå†…ã®GGAã§ã‚«ã‚¦ãƒ³ãƒˆ
if(nmeaLogElement&&nmeaData.length>0){
//NMEAãƒ­ã‚°è¡¨ç¤ºãŒéè¡¨ç¤º
if(nmeaLogElement.style.display!=='none'){
constlines=nmeaData.trim().split('\n');
if(lines.length>0){
constlatestLine=lines[lines.length-1].trim();
nmeaLogElement.textContent=latestLine;
}
}
}

processNmeaData(nmeaData);
}
}catch(error){
if(keepReading){
if(elem.debugInfo)elem.debugInfo.innerHTML=`USBèª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼:${error.message}`;
}
break;
}
}
}
//WebUSBæ¥ç¶šã‚’é–‹å§‹
asyncfunctionstartWebUsbGps(){
try{
if(elem.statusDisplay)elem.statusDisplay.textContent='USBãƒ‡ãƒã‚¤ã‚¹ã‚’æ¤œç´¢ä¸­...';
elem.gpsButton.textContent='æ¥ç¶šä¸­...';
device=awaitnavigator.usb.requestDevice({
filters:[{vendorId:NMEA_VENDOR_ID,productId:NMEA_PRODUCT_ID}]
});
awaitdevice.open();
if(device.configuration===null){
awaitdevice.selectConfiguration(device.configurations[0].configurationValue);
}
awaitdevice.claimInterface(INTERFACE_NUMBER);
if(elem.statusDisplay)elem.statusDisplay.textContent='GPSãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ¥ç¶šå®Œäº†ã€‚ãƒ‡ãƒ¼ã‚¿ç›£è¦–ä¸­...';

// --- å¤‰æ›´: æ¥ç¶šæˆåŠŸæ™‚ã€Fixã‚’å¾…ãŸãšä¸€æ—¦ç›£è¦–ä¸­çŠ¶æ…‹ã®è¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ãˆã‚‹ ---
elem.gpsButton.textContent='GPS(ç›£è¦–ä¸­)'; 
elem.gpsButton.classList.remove('no-gps');
// active-blueã®ä»˜ä¸ã¯ updateDebugDisplay ã«ä»»ã›ã‚‹ãŸã‚å‰Šé™¤
// ------------------

isGpsRunning=true;
keepReading=true;
startRateMeasurement();
readLoop();
}catch(error){
if(elem.debugInfo)elem.debugInfo.innerHTML=`USBæ¥ç¶šã‚¨ãƒ©ãƒ¼:${error.message}`;
stopGps();
}
}
//GPSç›£è¦–ã‚’é–‹å§‹ã™ã‚‹
functionstartGps(){
if(!isSettingsLoaded){
if(elem.debugInfo)elem.debugInfo.innerHTML="GPSè¨­å®šãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br>GETãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦è¨­å®šã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚";
return;
}
startWebUsbGps();
}
//GPSç›£è¦–ã‚’åœæ­¢ã™ã‚‹
asyncfunctionstopGps(){
stopRateMeasurement();
keepReading=false;
if(device){
try{
awaitdevice.releaseInterface(INTERFACE_NUMBER);
awaitdevice.close();
}catch(error){
//ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
}
device=null;
}
isGpsRunning=false;
if(elem.statusDisplay)elem.statusDisplay.textContent='GPSç›£è¦–åœæ­¢';

// --- å¤‰æ›´: åœæ­¢æ™‚ã¯åˆæœŸçŠ¶æ…‹ã«æˆ»ã™ ---
elem.gpsButton.textContent='GPS';
elem.gpsButton.classList.remove('active-blue');
elem.gpsButton.classList.add('no-gps');
// ------------------

if(elem.nmeaLog)elem.nmeaLog.textContent='NoNMEAdatayet...';
currentLat=0.0;
currentLon=0.0;
latestRmcStatus='N/A';
latestRmcRawLatLon='N/A';
latestGgaStatus='N/A';
latestGgaRawLatLon='N/A';
latestGgaFixQuality=0;//<---ADDEDreset
lastPosition=null;
//ğŸ’¡åœæ­¢æ™‚ã«ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ãƒªã‚»ãƒƒãƒˆ
latestDistance=0.0;
latestTimeSinceLap=0;
latestIsCrossing=false;
updateDebugDisplay();
}
//WebUSBã‹ã‚‰ã®ä½ç½®æƒ…å ±æ›´æ–°å‡¦ç†ï¼ˆãƒ©ãƒƒãƒ—è¨ˆæ¸¬ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
functiononWebUsbPositionUpdate(position){
if(swState!==SW_STATE.RUN||!isGpsRunning){
return;
}
lastUpdateTime=Date.now();
constcurrentLat=position.coords.latitude;
constcurrentLon=position.coords.longitude;
constcurrentTime=Date.now();
//ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ç¾¤
constcalculateDistance=(lat1,lon1,lat2,lon2)=>{
constR=6371e3;
constÏ†1=lat1*Math.PI/180;
constÏ†2=lat2*Math.PI/180;
constÎ”Ï†=(lat2-lat1)*Math.PI/180;
constÎ”Î»=(lon2-lon1)*Math.PI/180;
consta=Math.sin(Î”Ï†/2)*Math.sin(Î”Ï†/2)+Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(Î”Î»/2)*Math.sin(Î”Î»/2);
constc=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
returnR*c;
};
constcalculatePerpendicularFootApprox=(lineLat1,lineLon1,lineLat2,lineLon2,pointLat,pointLon)=>{
constdx=lineLon2-lineLon1;
constdy=lineLat2-lineLat1;
constlineLenSq=dx*dx+dy*dy;
if(lineLenSq<1e-9)return{latitude:lineLat1,longitude:lineLon1};
constt=((pointLon-lineLon1)*dx+(pointLat-lineLat1)*dy)/lineLenSq;
if(t<0)return{latitude:lineLat1,longitude:lineLon1};
if(t>1)return{latitude:lineLat2,longitude:lineLon2};
return{latitude:lineLat1+t*dy,longitude:lineLon1+t*dx};
};
constgetSideOfLine=(pointLat,pointLon,lineLat1,lineLon1,lineLat2,lineLon2)=>{
return(lineLon2-lineLon1)*(pointLat-lineLat1)-(lineLat2-lineLat1)*(pointLon-lineLon1);
};
constgetIntersectionTime=(p1,p2)=>{
//p1(lat,lon,time),p2(lat,lon,
//åˆ†æ¯
constden=(LAP_LINE_P2.lon-LAP_LINE_P1.lon)*(p2.lat-p1.lat)-(LAP_LINE_P2.lat-LAP_LINE_P1.lat)*(p2.lon-p1.lon);
if(Math.abs(den)<1e-9)returnnull;
//P1->P2é–“ã®äº¤å·®æ¯”ç‡t_ratioã®åˆ†å­
constt_num=(LAP_LINE_P2.lon-LAP_LINE_P1.lon)*(LAP_LINE_P1.lat-p1.lat)-(LAP_LINE_P2.lat-LAP_LINE_P1.lat)*(LAP_LINE_P1.lon-p1.lon);
constt_ratio=t_num/den;
if(t_ratio<0||t_ratio>1)returnnull;//P1-P2ã®ç·šåˆ†ã®å¤–å´ã§äº¤å·®
//ã‚¹ã‚¿ãƒ¼ãƒˆãƒ©ã‚¤ãƒ³ã®ç·šåˆ†ã®ç¯„å›²ãƒã‚§ãƒƒã‚¯(u)
constu_num=(LAP_LINE_P1.lat-p1.lat)*(p2.lon-p1.lon)-(LAP_LINE_P1.lon-p1.lon)*(p2.lat-p1.lat);
constu=u_num/den;
if(u<0||u>1)returnnull;//ã‚¹ã‚¿ãƒ¼ãƒˆãƒ©ã‚¤ãƒ³ã®ç·šåˆ†ã®å¤–å´
//æ¯”ç‡ã‚’ä½¿ã£ã¦æ™‚é–“ã‚’è£œé–“
returnp1.time+(p2.time-p1.time)*t_ratio;
};
//ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ç¾¤ã“ã“ã¾ã§
if(!lastPosition){
lastPosition={
lat:currentLat,
lon:currentLon,
time:currentTime,
speed:position.coords.speed||0
};
previousSideOfLine=getSideOfLine(currentLat,currentLon,LAP_LINE_P1.lat,LAP_LINE_P1.lon,LAP_LINE_P2.lat,LAP_LINE_P2.lon);
//ğŸ’¡åˆæœŸå€¤è¨­å®š
constP=calculatePerpendicularFootApprox(LAP_LINE_P1.lat,LAP_LINE_P1.lon,LAP_LINE_P2.lat,LAP_LINE_P2.lon,currentLat,currentLon);
latestDistance=calculateDistance(currentLat,currentLon,P.latitude,P.longitude);
latestTimeSinceLap=currentTime-lastLapTime;
latestIsCrossing=false;
return;
}
//lastPositionã®æ›´æ–°ã¯ã€ãƒ©ãƒƒãƒ—è¨ˆæ¸¬ãƒ­ã‚¸ãƒƒã‚¯ã®æœ€å¾Œã«ç§»å‹•ã—ã€GGAã¾ãŸã¯RMCã«ã‚ˆã£ã¦æœ€æ–°ã®é€Ÿåº¦ãŒæ—¢ã«lastPosition.speedã«å…¥ã£ã¦ã„ã‚‹ã“ã¨ã‚’å‰æã¨ã™ã‚‹
//lastPositionã®ç·¯åº¦/çµŒåº¦/æ™‚åˆ»ã‚’ä¸€æ™‚çš„ã«å¤‰æ•°ã«ä¿å­˜
constP1_lat=lastPosition.lat;
constP1_lon=lastPosition.lon;
constP1_time=lastPosition.time;
constcurrentSideOfLine=getSideOfLine(currentLat,currentLon,LAP_LINE_P1.lat,LAP_LINE_P1.lon,LAP_LINE_P2.lat,LAP_LINE_P2.lon);
constisCrossingLine=(previousSideOfLine>0&&currentSideOfLine<0)||(previousSideOfLine<0&&currentSideOfLine>0);
consttimeSinceLastLap=currentTime-lastLapTime;
constisCoolDownOver=(lapCount===0)||(timeSinceLastLap>=lapCoolDown);
constP=calculatePerpendicularFootApprox(LAP_LINE_P1.lat,LAP_LINE_P1.lon,LAP_LINE_P2.lat,LAP_LINE_P2.lon,currentLat,currentLon);
constdistanceToStartLine=calculateDistance(currentLat,currentLon,P.latitude,P.longitude);
constisNearStartLine=distanceToStartLine<=gpsThresholdValue;
//ğŸ’¡ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’æ›´æ–°
latestDistance=distanceToStartLine;
latestTimeSinceLap=timeSinceLastLap;
latestIsCrossing=isCrossingLine;
if(isCrossingLine&&isCoolDownOver&&isNearStartLine){
//é€Ÿåº¦ã«ä¾å­˜ã—ãªã„ã€ç´”ç²‹ãªç›´ç·šè£œé–“ç”¨ã®ä½ç½®ãƒ‡ãƒ¼ã‚¿
constP1_for_Intersection={
lat:P1_lat,
lon:P1_lon,
time:P1_time
};
constP2_for_Intersection={
lat:currentLat,
lon:currentLon,
time:currentTime
};
//P1ã¨P2ã‚’çµã¶ç·šåˆ†ã¨ã€ã‚¹ã‚¿ãƒ¼ãƒˆãƒ©ã‚¤ãƒ³ã®äº¤å·®æ™‚åˆ»ã‚’æ¨å®š
constintersectionTime=getIntersectionTime(P1_for_Intersection,P2_for_Intersection);
if(intersectionTime!==null){
//è£œé–“ã•ã‚ŒãŸæ­£ç¢ºãªäº¤å·®æ™‚åˆ»ã‚’ç”¨ã„ã¦ãƒ©ãƒƒãƒ—ã‚¿ã‚¤ãƒ ã‚’è¨ˆç®—
constlapDuration=intersectionTime-lapStartTime;
//ãƒ©ãƒƒãƒ—ã‚¿ã‚¤ãƒ ã‚’è¨˜éŒ²
lapCount++;
lapTimePrint(lapDuration);//ãƒ©ãƒƒãƒ—ãƒªã‚¹ãƒˆã«è¨˜éŒ²
//æ¬¡ã®ãƒ©ãƒƒãƒ—ã®ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚é–“ã‚’äº¤å·®æ™‚åˆ»ã«è¨­å®š
lapStartTime=intersectionTime;
lastLapTime=intersectionTime;//ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³åˆ¤å®šç”¨
//ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ©ãƒƒãƒ—è¡¨ç¤ºã‚’ä¸€æ™‚åœæ­¢
cancelAnimationFrame(lapTimerId);

//ãƒ¡ã‚¤ãƒ³ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã«ç¢ºå®šãƒ©ãƒƒãƒ—ã‚¿ã‚¤ãƒ ã‚’å›ºå®šè¡¨ç¤º
if(elem.display1)elem.display1.textContent=lapTimeToString(lapDuration);

//2ç§’å¾Œã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¨ˆæ¸¬ã‚’å†é–‹
if(lapFixedDisplayTimeoutId){
clearTimeout(lapFixedDisplayTimeoutId);
}
lapFixedDisplayTimeoutId=setTimeout(()=>{
//RUNçŠ¶æ…‹ã§ã‚ã‚Œã°æ¬¡ã®ãƒ©ãƒƒãƒ—ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¨ˆæ¸¬ã‚’é–‹å§‹
if(swState===SW_STATE.RUN){
startRealtimeLap();
}
},2000);
//ãƒ©ãƒƒãƒ—å¾Œã®ä½ç½®æƒ…å ±ã‚’æ›´æ–°(lastPosition.speedã¯RMCå‡¦ç†ã§æ—¢ã«æ›´æ–°ã•ã‚Œã¦ã„ã‚‹)
previousSideOfLine=currentSideOfLine;
lastPosition.lat=currentLat;
lastPosition.lon=currentLon;
lastPosition.time=currentTime;

}else{
//äº¤å·®æ™‚åˆ»ãŒè¨ˆç®—ã§ããªã‹ã£ãŸå ´åˆï¼ˆç¨€ãªã‚±ãƒ¼ã‚¹ï¼‰ã€ç¾åœ¨ã®ã‚µã‚¤ãƒ‰ã¨ä½ç½®æƒ…å ±ã‚’æ›´æ–°
previousSideOfLine=currentSideOfLine;
lastPosition.lat=currentLat;
lastPosition.lon=currentLon;
lastPosition.time=currentTime;
//lastPosition.speedã¯RMCå‡¦ç†ã§æ›´æ–°æ¸ˆã¿
}
}else{
//ãƒ©ã‚¤ãƒ³ã‚’æ¨ªåˆ‡ã‚‰ãªã‹ã£ãŸã€ã¾ãŸã¯ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³æœŸé–“ä¸­ã®å ´åˆã€ä½ç½®æƒ…å ±ã‚’æ›´æ–°
previousSideOfLine=currentSideOfLine;
lastPosition.lat=currentLat;
lastPosition.lon=currentLon;
lastPosition.time=currentTime;
//lastPosition.speedã¯RMCå‡¦ç†ã§æ›´æ–°æ¸ˆã¿
}
//ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚‚å¸¸ã«æœ€æ–°ã®ä½ç½®æƒ…å ±ã«åŸºã¥ã„ã¦æ›´æ–°
updateDebugDisplay();
}

//---åˆæœŸåŒ–å‡¦ç†---
window.onload=()=>{
//ç”»é¢è¦ç´ ã®å–å¾—
elem.display=document.getElementById('display');
elem.display1=document.getElementById('display1');
elem.lap_list=document.getElementById('lap_list');
elem.statusDisplay=document.getElementById('status-display');
elem.debugInfo=document.getElementById('debugInfo');
elem.startButton=document.getElementById('start');
elem.resetButton=document.getElementById('reset');
elem.lapButton=document.getElementById('lap');
elem.gpsButton=document.getElementById('gpsButton');
elem.getSettingsBtn=document.getElementById('getSettingsBtn');
elem.nmeaLog=document.getElementById('nmeaLog');
elem.nmeaRawContainer=document.getElementById('nmea-raw-container');

//ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
if(elem.startButton)elem.startButton.addEventListener('click',clickStartSW);
if(elem.resetButton)elem.resetButton.addEventListener('click',clickResetSW);
if(elem.lapButton)elem.lapButton.addEventListener('click',clickLapSW);
if(elem.gpsButton)elem.gpsButton.addEventListener('click',clickGpsButton);
if(elem.getSettingsBtn)elem.getSettingsBtn.addEventListener('click',getSettings);

//WebUSBå¯¾å¿œãƒã‚§ãƒƒã‚¯
if(!navigator.usb){
if(elem.statusDisplay)elem.statusDisplay.textContent='ã‚¨ãƒ©ãƒ¼:WebUSBéå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã§ã™ã€‚';
if(elem.gpsButton)elem.gpsButton.disabled=true;
}

//åˆå›è¡¨ç¤ºã®æ›´æ–°ã¨è¨­å®šã®èª­ã¿è¾¼ã¿
updateButtonDisplay();
getSettings();
updateDebugDisplay();
};
</script>
</body>
</html>
